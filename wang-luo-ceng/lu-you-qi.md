# 路由器
> 解决IP层面的连接运输工作，处理来自不同协议网络的连接和沟通，如以太网、令牌环网、802.11无线网络之间的网络融合，**将异构的网络标准化**。

通信的基础：建立虚电路连接（预留双方通信需要的网络资源如带宽，后沿着虚电路发送分组）

路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。
若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码


## 路由表
最主要的是两个信息：**目的网络**，**下一跳地址**，子网掩码（划分子网后）

工作原理：
  - IP数据报首先要设法找到目的主机所在的目的网络上的路由器
  - 路由器中有根据不同网段划分的转发方法，通过识别主机网段，选择将数据报如何转发与发送
  - 只有到达最后一个路由器时，才试图向目的主机进行直接交付
  
隧道穿透技术与VPN（L2TP etc.）
全球联网：ISP的多重端口映射

## 交换机与路由器的区别

|区别|交换机|路由器|
|-|-|-|
|作用范围   |  网络层 |数据链路层|
|隔离工作|连接两个网段，只隔离网段的碰撞域|连接两个不同网络，隔离广播域|
|转发方式|直通转发、存储转发|存储转发|
|转发地址  |MAC地址|IP地址|
|维护|转发表|路由表，转发表|
|使用 | 即插即用  |需要配置|  
联系：都是存储转发设备，都能转发分组，扩大网络的范围



## traceroute原理
利用ICMP报文与 TTL 的异常反馈：
![](/.src/pic/traceroute.png)

# 路由选择协议
> 路由选择协议的任务是，为路由器提供他们建立通过网状网络最佳路径所需要的相互共享的路由信息

从路由算法能否随网络的通信量或拓扑自适应地进行调整变化来划分
- 静态路由选择策略：非自适应路由选择，简单、开销小，不能及时适应网络状态的变化
- 动态路由选择策略：自适应路由选择，能较好地适应网络状态的变化，实现起来复杂，开销也较大

## RIP
分布式的基于距离向量的路由选择协议,即认为最佳路由就是 距离 最短的路由，其最大优点就是简单，但只适用于小型的互联网。要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。

距离（跳数）
- 从路由器到直接连接的网络的距离定义为1
- 从一路由器到非直接连接的网络的距离定义为所经过的路由器数加1
- “距离”的最大值为16，相当于不可达

交换信息
- RIP的分布式路由选择的特点是每一路由器都要不断地和其他一些路由器交换路由信息
- 仅和相邻路由器交换信息
- 交换的信息是当前本路由器所知道的全部信息，即自己的路由表
- 按固定的时间间隔交换路由信息

缺点
- 限制了网络规模
- 路由器之间交换的是路由器中完整的路由表,开销增加
- 用跳数作为度量，没有考虑带宽、时延等
- 每30s发送整个路由表，占用带宽大
- 坏消息传播得慢,使更新过程的收敛时间过长.

## OSPF
OSPF的三个要点
1. 向本自治系统中所有路由器发送信息。
2. 发送的信息是与本路由器相邻的所有路由器的链路状态(说明本路由器和哪些路由器相邻，以及该链路的度量metric
3. 只有当链路状态发生变化时，路由器才用洪泛法(flooding)向所有路由器发送此信息。

### 链路状态算法四个步骤
1. 当路由器初始化或当网络结构发生变化，路由器产生链路状态广播数据报LSA，该数据包里包含路由器上所有相连链路。
2. 所有路由器会通过洪泛法来交换链路状态数据，相邻路由器根据其接收到的链路状态信息更新自己的数据库，并将该链路状态信息转送给与其相邻的路由器，直至稳定的一个过程
3. 当网络重新稳定下来，也可以说OSPF路由协议收敛下来时，所有的路由器会根据其各自的链路状态信息数据库计算出各自的路由表
4. 网络状态比较稳定时，网络中传递的链路状态信息是比较少的

> OSPF采用层次结构的区域划分, 适用于规模很大的网络。好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量


![](/.src/pic/OSPF.png)